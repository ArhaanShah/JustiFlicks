# JustiFlicks Baseline CF Pipeline

## Quick Start

This repository contains a modular implementation of collaborative filtering baseline models extracted from the notebook pipeline.

### Prerequisites

```bash
pip install numpy pandas torch pyyaml
pip install implicit  # Optional, for implicit BPR model
pip install wandb     # Optional, for logging
```

### Pipeline Steps

#### 1. Create Train/Val/Test Splits

```bash
python -m src.cli.entrypoints create_splits --config configs/default.yaml
```

This creates:
- `artifacts/splits/train.parquet`, `val.parquet`, `test.parquet`
- `artifacts/splits/train_small.parquet`, `val_small.parquet`, `test_small.parquet`
- `artifacts/splits/item_support_table.parquet`
- `artifacts/splits/splits_manifest.json`

#### 2. Build Item Feature Embeddings

```bash
python -m src.cli.entrypoints build_embeddings --config configs/default.yaml
```

This creates:
- `embeddings/item/item_features.parquet` (one-hot language + genres)

#### 3. Train Models

**Matrix Factorization with BPR:**
```bash
python -m src.cli.entrypoints train_mf --config configs/default.yaml
```

**Implicit BPR (requires `implicit` library):**
```bash
python -m src.cli.entrypoints train_implicit_bpr --config configs/default.yaml
```

**Two-Tower Content Model:**
```bash
python -m src.cli.entrypoints train_two_tower --config configs/default.yaml
```

Each training command saves artifacts to `artifacts/<model_name>/`:
- `user_embeddings.npy`, `item_embeddings.npy`
- `user_index.csv`, `item_index.csv`
- `<model>_model.pt` or `.npz`
- `<model>_metadata.json`
- `metrics.json`
- `slices_long.csv`

#### 4. Evaluate All Models

```bash
python -m src.cli.entrypoints eval_all --config configs/default.yaml
```

#### 5. Reproducibility Evaluation

Run reproducibility evaluation across multiple seeds:

```bash
python -m src.cli.entrypoints reproducibility_eval --config configs/reproducibility.yaml
```

Output format:
```
[REPRO] model=MF seed=34 ndcg@10=0.123456
[REPRO] model=MF seed=35 ndcg@10=0.123789
...
```

## Configuration

### `configs/default.yaml`

Main configuration with:
- `data_root`: Path to processed data parquet files
- `embedding_root`: Path to store/load embeddings
- `artifact_root`: Path to store model artifacts
- `rating_threshold`: Threshold for positive ratings (default: 4.5)
- `k_values`: List of k values for evaluation (default: [5, 10, 20])
- `seed`: Random seed for reproducibility
- Model-specific hyperparameters under `MF`, `implicitBPR`, `twoTower`

### `configs/reproducibility.yaml`

Reproducibility evaluation settings:
- `seeds`: List of seeds to evaluate
- `sample_frac`: Fraction of users to sample
- `min_users`, `max_users`: Bounds on sampled users
- `k`: k value for NDCG computation

## Project Structure

```
├── configs/
│   ├── default.yaml           # Main config
│   └── reproducibility.yaml   # Reproducibility settings
├── src/
│   ├── utils/
│   │   └── config.py          # Config loading + seed setting
│   ├── data/
│   │   └── splits.py          # Split creation logic
│   ├── eval/
│   │   └── helper.py          # Evaluation metrics (NDCG, Recall, MAP, etc.)
│   ├── embeddings/
│   │   └── langGenre.py       # Item feature builder
│   ├── models/
│   │   ├── MF.py              # MF_BPR model
│   │   ├── implicitBPR.py     # Implicit BPR wrapper
│   │   └── twoTower.py        # Two-Tower content model
│   └── cli/
│       └── entrypoints.py     # CLI commands
├── embeddings/
│   └── item/
│       └── item_features.parquet  # Generated by build_embeddings
└── artifacts/
    ├── splits/                # Generated by create_splits
    ├── MF/                    # MF model artifacts
    ├── implicitBPR/           # Implicit BPR artifacts
    └── twoTower/              # Two-Tower artifacts
```

## Metrics

The evaluation produces:
- `ndcg@k`: Normalized Discounted Cumulative Gain
- `recall5@k`: Recall with rating threshold 5.0
- `map5@k`: Mean Average Precision with rating threshold 5.0
- `mean_popularity_num_votes@k`: Average popularity of recommendations
- `prop_top10pct_popularity@k`: Proportion of top-10% popular items
- Slice-based metrics by support, IMDb votes, and era
